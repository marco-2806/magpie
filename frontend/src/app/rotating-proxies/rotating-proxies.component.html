@if (loading) {
  <div class="rotating-loading">Loading rotating proxies…</div>
} @else {
  <div class="rotating-container">
    <section class="create-card">
      <div class="card-header">
        <h2>Create Rotating Proxy</h2>
        <p class="subtitle">Rotate through your healthy proxies for a chosen protocol.</p>
      </div>

      <form [formGroup]="createForm" (ngSubmit)="createRotator()" class="create-form">
        <div class="form-field">
          <label for="rotatorName">Name</label>
          <input id="rotatorName"
                 type="text"
                 pInputText
                 placeholder="My rotating proxy"
                 maxlength="120"
                 formControlName="name"
                 [disabled]="submitting || noProtocolsAvailable">
          @if (createForm.get('name')?.invalid && (createForm.get('name')?.dirty || createForm.get('name')?.touched)) {
            <small class="error">Name is required and must be under 120 characters.</small>
          }
        </div>

        <div class="form-field">
          <label for="rotatorProtocol">Protocol</label>
          <p-select inputId="rotatorProtocol"
                    [options]="protocolOptions"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Select a protocol"
                    formControlName="protocol"
                    [disabled]="submitting || noProtocolsAvailable">
          </p-select>
          @if (noProtocolsAvailable) {
            <small class="hint">Enable at least one protocol in your account settings to create a rotator.</small>
          } @else {
            <small class="hint">Ports are assigned automatically within the published range.</small>
          }
        </div>

        <div class="form-field">
          <label for="reputationFilter">Reputation Filter</label>
          <p-multiSelect inputId="reputationFilter"
                         display="chip"
                         formControlName="reputationLabels"
                         [options]="reputationOptions"
                         optionLabel="label"
                         optionValue="value"
                         [disabled]="submitting">
          </p-multiSelect>
          <small class="hint">Pick which proxy reputations this rotator can serve. Leave empty to use every available proxy.</small>
        </div>

        <div class="auth-options">
          <label class="auth-toggle">
            <input type="checkbox" formControlName="authRequired" [disabled]="submitting">
            <span>Require authentication</span>
          </label>

          @if (authEnabled) {
            <div class="auth-grid">
              <div class="form-field">
                <label for="authUsername">Auth Username</label>
                <input id="authUsername"
                       type="text"
                       pInputText
                       maxlength="120"
                       formControlName="authUsername"
                       [disabled]="submitting">
              </div>

              <div class="form-field">
                <label for="authPassword">Auth Password</label>
                <input id="authPassword"
                       type="text"
                       pInputText
                       maxlength="120"
                       formControlName="authPassword"
                       [disabled]="submitting">
              </div>
            </div>
          }
        </div>

        <button pButton
                type="submit"
                label="Create"
                icon="pi pi-plus"
                [disabled]="createForm.invalid || submitting || noProtocolsAvailable"
                [loading]="submitting">
        </button>
      </form>
    </section>

    <section class="list-card">
      <div class="card-header spaced">
        <div>
          <h2>Rotating Proxies</h2>
          <p class="subtitle">Manage existing rotators and fetch fresh proxies on demand.</p>
        </div>
        <button pButton type="button" label="Refresh" icon="pi pi-refresh" (click)="loadInitialData()" [disabled]="loading"></button>
      </div>

      <p-table [value]="rotatingProxies" [tableStyle]="{'min-width': '640px'}" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>Name</th>
            <th>Protocol</th>
            <th>Rotator Access</th>
            <th>Alive Proxies</th>
            <th>Last Rotation</th>
            <th>Last Served Proxy</th>
            <th class="actions">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-proxy>
          <tr>
            <td class="name-cell">
              <div class="name">{{ proxy.name }}</div>
              <div class="created">Created {{ proxy.created_at | date:'short' }}</div>
              <div class="reputation-filter">
                <span class="filter-label">REPUTATION
                  <br>
                <span class="filter-value">{{ reputationFilterSummary(proxy.reputation_labels) }}</span>
                </span>
              </div>
            </td>
            <td>
              <span class="protocol-tag">{{ protocolLabel(proxy.protocol) }}</span>
            </td>
            <td>
              <div class="rotator-cell">
                <button type="button"
                        pButton
                        class="p-button-text p-button-sm rotator-link"
                        [label]="rotatorEndpoint(proxy) || 'View details'"
                        (click)="showRotatorDetails(proxy)"
                        [disabled]="!rotatorEndpoint(proxy)">
                </button>
                <span class="muted hint-text">Click to view credentials</span>
              </div>
            </td>
            <td>
              <span class="alive-count">{{ proxy.alive_proxy_count }}</span>
            </td>
            <td>
              @if (proxy.last_rotation_at) {
                {{ proxy.last_rotation_at | date:'short' }}
              } @else {
                <span class="muted">Never</span>
              }
            </td>
            <td>
              @if (proxy.last_served_proxy) {
                <code>{{ proxy.last_served_proxy }}</code>
              } @else {
                <span class="muted">Not rotated yet</span>
              }
            </td>
            <td class="actions">
              <div class="action-buttons">
                <button pButton type="button"
                        icon="pi pi-sync"
                        label="Rotate"
                        (click)="rotate(proxy)"
                        [loading]="rotateLoading.has(proxy.id)"
                        [disabled]="rotateLoading.has(proxy.id)">
                </button>
                <button pButton type="button"
                        icon="pi pi-trash"
                        label="Delete"
                        severity="danger"
                        (click)="deleteProxy(proxy)"
                        [disabled]="rotateLoading.has(proxy.id)">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <p>No rotating proxies yet.</p>
                <p class="hint">Create one above to start rotating through healthy proxies.</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </section>

    @if (preview) {
      <section class="preview-card">
        <div class="card-header">
          <h2>Latest Rotation</h2>
          <p class="subtitle">{{ preview.name }} · {{ protocolLabel(preview.protocol) }}</p>
        </div>

        <div class="preview-content">
          <div class="preview-row">
            <span class="label">Rotator</span>
            @if (rotatorConnectionString(previewRotator)) {
              <span class="value">{{ rotatorConnectionString(previewRotator) }}</span>
            } @else {
              <span class="value muted">Unavailable</span>
            }
          </div>
          <div class="preview-row">
            <span class="label">Address</span>
            <span class="value">{{ preview.ip }}:{{ preview.port }}</span>
          </div>
          <div class="preview-row">
            <span class="label">Authentication</span>
            @if (preview.has_auth && preview.username && preview.password) {
              <span class="value">{{ preview.username }} / {{ preview.password }}</span>
            } @else {
              <span class="value muted">None</span>
            }
          </div>
        </div>

        <div class="preview-actions">
          <button pButton type="button"
                  label="Copy Proxy"
                  icon="pi pi-copy"
                  (click)="copyPreview(preview)">
          </button>
          <button pButton type="button"
                  label="Copy Rotator"
                  icon="pi pi-copy"
                  (click)="copyRotatorConnection(previewRotator)"
                  [disabled]="!rotatorConnectionString(previewRotator)">
          </button>
        </div>
      </section>
    }
  </div>
}

<p-dialog
  [(visible)]="detailsVisible"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{width: '625px'}"
  [breakpoints]="{'960px': '70vw', '640px': '90vw'}"
  (onHide)="onDetailsHide()"
  [header]="selectedRotator ? selectedRotator.name + ' · ' + protocolLabel(selectedRotator.protocol) : 'Rotator Details'">
  @if (selectedRotator) {
    <div class="details-dialog">
      <div class="details-grid">
        <div class="detail-row">
          <span class="label">Endpoint</span>
          <span class="value">{{ rotatorEndpoint(selectedRotator) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Connection</span>
          @if (rotatorConnectionString(selectedRotator)) {
            <span class="value">{{ rotatorConnectionString(selectedRotator) }}</span>
          } @else {
            <span class="value muted">Unavailable</span>
          }
        </div>
        <div class="detail-row">
          <span class="label">Reputation Filter</span>
          <span class="value">{{ reputationFilterSummary(selectedRotator.reputation_labels) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Authentication</span>
          @if (selectedRotator.auth_required && selectedRotator.auth_username && selectedRotator.auth_password) {
            <span class="value">{{ selectedRotator.auth_username }} / {{ selectedRotator.auth_password }}</span>
          } @else if (selectedRotator.auth_required) {
            <span class="value muted">Credentials required</span>
          } @else {
            <span class="value muted">Not required</span>
          }
        </div>
      </div>

      <div class="details-actions">
        <button pButton type="button"
                label="Copy Connection"
                icon="pi pi-copy"
                (click)="copyRotatorConnection(selectedRotator)"
                [disabled]="!rotatorConnectionString(selectedRotator)">
        </button>
        <button pButton type="button"
                label="Copy Username"
                icon="pi pi-user"
                (click)="copyRotatorField(selectedRotator.auth_username, 'Username')"
                [disabled]="!selectedRotator.auth_username">
        </button>
        <button pButton type="button"
                label="Copy Password"
                icon="pi pi-lock"
                (click)="copyRotatorField(selectedRotator.auth_password, 'Password')"
                [disabled]="!selectedRotator.auth_password">
        </button>
      </div>
    </div>
  } @else {
    <div class="empty-details muted">Select a rotator to view details.</div>
  }
</p-dialog>
