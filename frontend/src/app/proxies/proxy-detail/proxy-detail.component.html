<div class="proxy-detail-page lg:px-10">
  <a
    routerLink="/proxies"
    class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium transition-colors back-button"
  >
    <i class="pi pi-arrow-left text-xs"></i>
    Back to proxies
  </a>

  <div class="mt-6 flex flex-col gap-6">
    <section class="detail-card p-6 shadow detail-overview">
      <div class="flex flex-wrap items-start gap-4 detail-overview__header">
        <div class="flex-1 min-w-0 w-full">
          <h1 class="text-2xl font-semibold">
            Proxy
            <ng-container *ngIf="detail?.ip; else proxyIdHeading">
              <span class="proxy-address inline-flex items-center gap-1.5 flex-wrap ml-2 text-base">
                <button type="button" class="address-chip" (click)="copyIp()" title="Copy IP">
                  {{ detail?.ip }}
                </button>
                <ng-container *ngIf="detail?.port !== undefined && detail?.port !== null">
                  <span class="value-separator">:</span>
                  <button type="button" class="address-chip" (click)="copyPort()" title="Copy Port">
                    {{ detail?.port }}
                  </button>
                  <button
                    type="button"
                    pButton
                    icon="pi pi-copy"
                    class="copy-address-button"
                    (click)="copyFullAddress()"
                    title="Copy IP and port"
                  ></button>
                  @if (fullCredentialAddress) {
                    <button
                      type="button"
                      pButton
                      icon="pi pi-link"
                      class="copy-address-button"
                      (click)="copyFullCredentialAddress()"
                      title="Copy IP, port, username and password"
                    ></button>
                  }
                </ng-container>
              </span>
            </ng-container>
          </h1>
          <ng-template #proxyIdHeading>
            <span class="ml-2">{{ proxyId || '—' }}</span>
          </ng-template>
        </div>
        <span
          class="inline-flex items-center gap-2 px-3 py-1 text-xs font-semibold uppercase tracking-wide flex-shrink-0 ml-auto status-pill"
          [ngClass]="{
            'status-pill--dead': latestStatistic && !latestStatistic.alive,
            'status-pill--unknown': !latestStatistic
          }"
        >
          <span
            class="status-dot"
            [ngClass]="{
              alive: latestStatistic?.alive,
              dead: latestStatistic && !latestStatistic.alive,
              unknown: !latestStatistic
            }"
          ></span>
          {{ latestStatistic ? (latestStatistic.alive ? 'Alive' : 'Dead') : 'Unknown' }}
        </span>
        <div class="text-sm muted-text flex flex-col sm:flex-row sm:items-center sm:gap-2 basis-full">
          <span class="shrink-0">Proxy ID {{ proxyId || '—' }}</span>
          <ng-container *ngIf="externalLookupLinks.length">
            <span class="hidden sm:inline muted-divider" aria-hidden="true">|</span>
            <div class="flex flex-wrap items-center gap-2 mt-2 sm:mt-0 w-full sm:flex-1 sm:min-w-0">
              <ng-container *ngFor="let link of externalLookupLinks">
                <a
                  class="external-link-chip"
                  [href]="link.url"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  @if (link.icon != '') {
                    <img [src]="link.icon" alt="" />
                  }
                  {{ link.label }}
                  <i class="pi pi-external-link"></i>
                </a>
              </ng-container>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="mt-6 detail-overview__content">
        @if (isLoadingDetail) {
          <div class="flex justify-center py-10">
            <app-loading></app-loading>
          </div>
        } @else {
          <div class="detail-overview__layout">
            <div class="detail-overview__grid grid grid-cols-1 sm:grid-cols-2 gap-5">
              <div class="detail-item">
                <div class="label">Country</div>
                <div class="value capitalize">{{ detail?.country || 'Unknown' }}</div>
              </div>
              <div class="detail-item">
                <div class="label">Estimated Type</div>
                <div class="value capitalize">{{ detail?.estimated_type || 'N/A' }}</div>
              </div>
              <div class="detail-item">
                <div class="label">Authentication</div>
                <div class="value break-all">
                  @if (authenticationCredentials; as credentials) {
                    <span class="auth-credentials inline-flex items-center gap-1.5 flex-wrap">
                      <button
                        type="button"
                        class="credential-chip"
                        (click)="copyUsername()"
                        title="Copy username"
                      >
                        {{ credentials.username }}
                      </button>
                      <span class="value-separator">:</span>
                      <button
                        type="button"
                        class="credential-chip"
                        (click)="copyPassword()"
                        title="Copy password"
                      >
                        {{ credentials.password }}
                      </button>
                      <button
                        type="button"
                        pButton
                        icon="pi pi-copy"
                        class="copy-credential-button"
                        (click)="copyAuthCredentials()"
                        title="Copy username and password"
                      ></button>
                    </span>
                  } @else {
                    {{ authenticationDisplay }}
                  }
                </div>
              </div>
              <div class="detail-item">
                <div class="label">Latest Protocol</div>
                <div class="value capitalize">{{ latestStatistic?.protocol || 'Unknown' }}</div>
              </div>
              <div class="detail-item">
                <div class="label">Anonymity</div>
                <div class="value capitalize">{{ latestStatistic?.anonymity_level || 'Unknown' }}</div>
              </div>
              <div class="detail-item">
                <div class="label">Latest Judge</div>
                <div class="value">{{ latestStatistic?.judge || 'Unknown' }}</div>
              </div>
              <div class="detail-item">
                <div class="label">Response Time</div>
                <div class="value">{{ latestStatistic?.response_time ?? '—' }}<span *ngIf="latestStatistic"> ms</span></div>
              </div>
              <div></div>
              <div class="detail-item">
                <div class="label">Last Check</div>
                <div class="value">{{ detail?.latest_check ? (detail?.latest_check | date : 'medium') : 'Never' }}</div>
              </div>
              <div class="detail-item">
                <div class="label">Created</div>
                <div class="value">{{ detail?.created_at ? (detail?.created_at | date : 'medium') : 'Unknown' }}</div>
              </div>
            </div>

            <div class="stats-chart">
              <div class="stats-chart__header">
                <div>
                  <h2 class="text-lg font-semibold">Response Time</h2>
                  <p class="text-xs muted-text">Most recent {{ chronologicalStats.length }} checks</p>
                </div>
              </div>

              <div class="stats-chart__body">
                @if (isLoadingStatistics) {
                  <div class="flex justify-center items-center h-full"><app-loading></app-loading></div>
                } @else if (chartData?.datasets?.[0]?.data?.length) {
                  <p-chart
                    type="line"
                    [data]="chartData"
                    [options]="chartOptions"
                    class="h-56 w-full"
                  ></p-chart>
                } @else {
                  <div class="flex items-center justify-center h-full text-sm muted-text">
                    No statistics recorded yet.
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </section>
  </div>

  @if (hasReputation) {
    <section class="detail-card simple-reputation mt-8">
      <div class="simple-reputation__header">
        <div>
          <div class="label">Reputation</div>
          <p class="muted-text" *ngIf="reputationOverall">
            Composite score from the proxy's latest signals.
          </p>
        </div>
        <div class="simple-reputation__summary" *ngIf="reputationOverall as overall; else noReputationFallback">
          <div class="simple-reputation__score">
            {{ reputationScoreDisplay(overall) }}
            <span>/100</span>
          </div>
          <span [ngClass]="reputationBadgeClass(overall.label)">
            {{ (overall.label || 'Unknown') | titlecase }}
          </span>
        </div>
        <button
          *ngIf="hasSignals(reputationOverall)"
          type="button"
          pButton
          icon="pi pi-sparkles"
          label="Signals"
          class="signals-button p-button-outlined"
          (click)="openSignalsDialog(reputationOverall!)"
        ></button>
      </div>
      <ng-template #noReputationFallback>
        <div class="muted-text text-sm">No overall score yet.</div>
      </ng-template>

      <div class="simple-reputation__progress" *ngIf="reputationOverall as overall">
        <div class="progress-bar">
          <div
            class="progress-bar__fill"
            [ngClass]="progressFillClass(overall.label)"
            [style.width.%]="reputationScorePercent(overall)"
          ></div>
        </div>
        <span class="progress-bar__value">{{ reputationScorePercent(overall) }}%</span>
      </div>

      <div class="simple-reputation__protocols" *ngIf="reputationProtocols.length > 0">
        <div class="protocol-row" *ngFor="let protocol of reputationProtocols">
          <div class="protocol-row__top">
            <span class="protocol-row__name">{{ protocol.kind | uppercase }}</span>
            <span class="protocol-row__score">{{ reputationScoreDisplay(protocol) }}</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-bar__fill"
              [ngClass]="progressFillClass(protocol.label)"
              [style.width.%]="reputationScorePercent(protocol)"
            ></div>
          </div>
          <div class="protocol-row__footer">
            <span class="protocol-row__badge" [ngClass]="reputationBadgeClass(protocol.label)">
              {{ (protocol.label || 'Unknown') | titlecase }}
            </span>
            <button
              *ngIf="hasSignals(protocol)"
              type="button"
              pButton
              class="p-button-text protocol-row__signals"
              label="Signals"
              (click)="openSignalsDialog(protocol)"
            ></button>
          </div>
        </div>
      </div>
    </section>
  }

  <section class="mt-8 detail-card p-6 shadow">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <div>
        <h2 class="text-lg font-semibold">Proxy Statistic History</h2>
        <p class="text-xs muted-text">Chronological list of judge results</p>
      </div>
      <span class="text-xs muted-text">{{ statistics.length }} entries</span>
    </div>

    <div class="mt-4">
      @if (isLoadingStatistics) {
        <div class="flex justify-center py-8"><app-loading></app-loading></div>
      } @else {
        <p-table
          [value]="statistics"
          [tableStyleClass]="'proxy-stat-table'"
          [responsiveLayout]="'scroll'"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Checked At</th>
              <th>Status</th>
              <th>Response Time</th>
              <th>Attempt</th>
              <th>Protocol</th>
              <th>Anonymity</th>
              <th>Judge</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr
              class="proxy-stat-row"
              role="button"
              tabindex="0"
              title="View judge response body"
              (click)="openStatisticResponse(row)"
              (keydown.enter)="openStatisticResponse(row)"
              (keydown.space)="openStatisticResponse(row); $event.preventDefault()"
            >
              <td>{{ row.created_at | date : 'medium' }}</td>
              <td>
                <div class="flex items-center gap-2">
                  <span
                    class="status-dot status-dot--small"
                    [ngClass]="row.alive ? 'alive' : 'dead'"
                  ></span>
                  <span class="text-sm">{{ row.alive ? 'Alive' : 'Dead' }}</span>
                </div>
              </td>
              <td>{{ row.response_time }} ms</td>
              <td>{{ row.attempt + 1}}</td>
              <td class="capitalize">{{ row.protocol || 'Unknown' }}</td>
              <td class="capitalize">{{ row.anonymity_level || 'Unknown' }}</td>
              <td>{{ row.judge || 'Unknown' }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="text-center py-6 muted-text">No statistics recorded yet.</td>
            </tr>
          </ng-template>
        </p-table>
      }
    </div>
  </section>

  <p-dialog
    [header]="signalDialogTitle || 'Signals'"
    [(visible)]="isSignalDialogVisible"
    [modal]="true"
    [blockScroll]="true"
    [dismissableMask]="true"
    [closable]="true"
    [style]="{ width: 'min(720px, 95vw)' }"
    [contentStyle]="{ 'max-height': '72vh', 'overflow-y': 'auto' }"
    styleClass="signal-dialog"
    (onHide)="onSignalDialogHide()"
  >
    <ng-template #structuredList let-items let-level="level">
      @if (items?.length) {
        <div
          class="signal-structured-list"
          [ngClass]="{
            'signal-structured-list--nested': (level ?? 0) > 0,
            'signal-structured-list--protocol': isProtocolList(items)
          }"
        >
          <div class="structured-row" *ngFor="let item of items" [ngClass]="{ 'structured-row--protocol': item.layout === 'protocol' }">
            <div class="structured-row__label">{{ item.label }}</div>
            <div class="structured-row__value">
              @if (item.children?.length) {
                <ng-container
                  *ngTemplateOutlet="structuredList; context: { $implicit: item.children, level: (level ?? 0) + 1 }"
                ></ng-container>
              } @else {
                {{ item.value }}
              }
            </div>
          </div>
        </div>
      }
    </ng-template>

    <ng-container *ngIf="signalDialogEntries.length; else noSignalsFallback">
      <div class="signal-dialog__list mt-5">
        <div class="signal-dialog__item" *ngFor="let signal of signalDialogEntries">
          <div class="signal-dialog__key">{{ signal.key }}</div>
          <div
            class="signal-dialog__value"
            [ngClass]="[
              signalToneClass(signal.tone),
              signal.isJson ? 'signal-dialog__value--json' : '',
              signal.structuredItems?.length ? 'signal-dialog__value--structured' : '',
              signal.rawKey === 'components' ? 'signal-dialog__value--protocols' : ''
            ]"
          >
            @if (signal.structuredItems?.length) {
              <ng-container *ngTemplateOutlet="structuredList; context: { $implicit: signal.structuredItems, level: 0 }"></ng-container>
            } @else if (signal.isJson) {
              <pre class="signal-dialog__value-json">{{ signal.value }}</pre>
            } @else {
              <span class="signal-dialog__value-text">{{ signal.value }}</span>
            }
            <span class="signal-dialog__sentiment">{{ signalToneLabel(signal.tone) }}</span>
          </div>
        </div>
      </div>
    </ng-container>
    <ng-template #noSignalsFallback>
      <div class="signal-dialog__empty muted-text">No signals available.</div>
    </ng-template>
  </p-dialog>

  <p-dialog
    header="Judge Response"
    [(visible)]="isResponseBodyModalVisible"
    [modal]="true"
    [blockScroll]="true"
    [dismissableMask]="true"
    [closable]="true"
    [style]="{ width: 'min(680px, 95vw)' }"
    styleClass="stat-response-dialog"
    (onHide)="onResponseDialogHide()"
  >
    <ng-container *ngIf="selectedStatistic as stat">
      <div class="stat-response-dialog__meta mt-4">
        <div class="meta-row">
          <span class="meta-label">Checked</span>
          <span class="meta-value">{{ stat.created_at | date : 'medium' }}</span>
        </div>
        <div class="meta-row">
          <span class="meta-label">Judge</span>
          <span class="meta-value">{{ stat.judge || 'Unknown' }}</span>
        </div>
        @if (selectedRegex) {
          <div class="meta-row">
            <span class="meta-label">Regex</span>
            <span class="meta-value font-mono break-all">{{ selectedRegex }}</span>
          </div>
        }
        <div class="meta-row">
          <span class="meta-label">Protocol</span>
          <span class="meta-value capitalize">{{ stat.protocol || 'Unknown' }}</span>
        </div>
        <div class="meta-row">
          <span class="meta-label">Status</span>
          <span class="meta-value">{{ stat.alive ? 'Alive' : 'Dead' }}</span>
        </div>
      </div>
    </ng-container>

    <div class="stat-response-dialog__content">
      @if (isLoadingResponseBody) {
        <div class="stat-response-dialog__loading">
          <app-loading></app-loading>
        </div>
      } @else if (responseBodyError) {
        <div class="stat-response-dialog__error">
          {{ responseBodyError }}
        </div>
      } @else if (selectedResponseBody) {
        <pre class="stat-response-dialog__body" [innerHTML]="highlightedResponseBody"></pre>
      } @else {
        <div class="stat-response-dialog__empty">
          No response body recorded for this check.
        </div>
      }
    </div>
  </p-dialog>
</div>
